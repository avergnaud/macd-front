<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">
</head>

<body>

  <h1>Test</h1>
  <div class="container">
      <div class="row">
          <div id="chart-area"></div>
      </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.1/d3.min.js" integrity="sha256-SQJ/nCYPXFPuqoS56EfnesDBPNiitndOIfN2WdPRi/o=" crossorigin="anonymous"></script>
  <script>


    const margin = {
      top: 50,
      right: 55,
      bottom: 50,
      left: 0,
      axis: 55
    },
      width = 435 + margin.right + margin.left,
      height = 167 + margin.top + margin.bottom,
      timeFormat = d3.timeFormat("%Y-%m-%d"),
      x_scale = d3.scaleTime(),
      y_scale = d3.scaleLinear(),
      svg = d3.select("#chart-area").append("svg")
        .attr("width", width)
        .attr("height", height),
      g = svg.append("g")
        .attr("transform(0,0)");

    let rectSelection = svg.selectAll("rect");

    let xAxis = d3.axisBottom(x_scale)
      .ticks(5)
      .tickPadding(5)
      .tickFormat(timeFormat),
      yAxis = d3.axisRight(y_scale)
        .tickFormat(d => (d + "â‚¬"));

    const x_axis = svg.append('g')
      .attr("class", "xaxis")
      .attr('transform', 'translate(0, ' + (height - margin.bottom) + ')'),
      y_axis = svg.append('g')
        .attr("class", "yaxis")
        .attr('transform', 'translate(' + (width - margin.axis) + ', 0)');

    d3.json("http://localhost:8080/ohlc/?chartEntityId=9395")
      .then(data => {

        const zoom = d3.zoom()
          .on("zoom", zoomed);

        data = data.map(item => ({
          timeStamp: item.timeEpochTimestamp * 1000,
          time: new Date(item.timeEpochTimestamp * 1000),
          open: item.openingPrice,
          high: item.highPrice,
          low: item.lowPrice,
          close: item.closingPrice
        }));

        let day = new Date();
        day.setDate(day.getDate() - 25);
        const xMin = day;
        const xMax = d3.max(data, d => new Date(Math.max(d.timeStamp)));
        x_scale.domain([xMin, xMax])
          .range([margin.left, width - margin.right]);

        let visibleData = data.filter(item => (
          item.time >= x_scale.invert(margin.left)
          && item.time <= x_scale.invert(width - margin.right)
        ));

        const yMin = d3.min(visibleData, d => Math.min(d.low));
        const yMax = d3.max(visibleData, d => Math.max(d.high));
        y_scale.domain([yMin, yMax])
          .range([height - margin.top, margin.bottom]);

        rectSelection = rectSelection.data(data).enter()
          .append("svg:rect")
          .attr("width", 10)
          .attr("x", d => x_scale(d.time))
          .attr("y", d => y_scale(Math.max(d.open, d.close)))
          .attr("height", d => (y_scale(Math.min(d.open, d.close)) - y_scale(Math.max(d.open, d.close))))
          .attr("fill", d => (d.open > d.close ? "red" : "green"))
          .attr("stroke", "black");

        y_axis.call(yAxis);

        x_axis.call(xAxis);

        svg.call(zoom);

        function zoomed() {

          let new_x_scale = d3.event.transform.rescaleX(x_scale);
          xAxis = xAxis.scale(new_x_scale);
          x_axis.call(xAxis);

          let visibleData = data.filter(item => (
            item.time >= new_x_scale.invert(margin.left)
            && item.time <= new_x_scale.invert(width - margin.right)
          ));

          const yMin = d3.min(visibleData, d => Math.min(d.low));
          const yMax = d3.max(visibleData, d => Math.max(d.high));
          y_scale.domain([yMin, yMax]);
          yAxis = yAxis.scale(y_scale);
          y_axis.call(yAxis);

          rectSelection
            .attr("x", d => new_x_scale(d.time))
            .attr("y", d => y_scale(Math.max(d.open, d.close)))
            .attr("height", d => (y_scale(Math.min(d.open, d.close)) - y_scale(Math.max(d.open, d.close))))

            ;
        }
      });


  </script>
</body>

</html>