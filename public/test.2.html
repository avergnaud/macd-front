<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" rel="stylesheet"
    integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">


  <style>
    div.tooltip {
      position: absolute;
      text-align: center;
      padding: 5px;
      font: 14px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
  </style>

</head>

<body>

  <h1>Test</h1>
  <div class="container">
    <div class="row">
      <div id="chart-area"></div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.1/d3.min.js"
    integrity="sha256-SQJ/nCYPXFPuqoS56EfnesDBPNiitndOIfN2WdPRi/o=" crossorigin="anonymous"></script>
  <script>


    const margin = {
      top: 50,
      right: 50,
      bottom: 50,
      left: 0,
      yaxis: 50
    },
      width = 435 + margin.right + margin.left,
      height = 167 + margin.top + margin.bottom,
      timeFormat = d3.timeFormat("%Y-%m-%d"),
      x_scale = d3.scaleTime(),
      y_scale = d3.scaleLinear(),
      svg = d3.select("#chart-area").append("svg")
        .attr("width", width)
        .attr("height", height)
    clippath = svg.append("clipPath")
      .attr("id", "clip")
      .append("rect")
      .attr("width", width)
      .attr("height", height),
      g = svg.append("g")
        .attr("transform", "translate(-" + margin.yaxis + ",0)");

    let rectSelection = g.selectAll("rect");

    let xAxis = d3.axisBottom(x_scale)
      .ticks(5)
      .tickPadding(5)
      .tickFormat(timeFormat),
      yAxis = d3.axisRight(y_scale)
        .tickFormat(d => (d + "€"));

    const x_axis = g.append('g')
      .attr("class", "xaxis")
      .attr('transform', 'translate(0, ' + (height - margin.bottom) + ')'),
      y_axis = svg.append('g')
        .attr("class", "yaxis")
        .attr('transform', 'translate(' + (width - margin.yaxis) + ', 0)');

    // Define the div for the tooltip
    const div = d3.select("#chart-area").append("div")
      .attr("class", "tooltip")
      .style("opacity", 0);

    d3.json("http://localhost:8080/ohlc/?chartEntityId=9395")
      .then(data => {

        const zoom = d3.zoom()
          /*.translateExtent([[-Infinity, -Infinity], [Infinity, Infinity]])
          .extent([[0,0],[width - margin.right, height]])*/
          .on("zoom", zoomed);

        data = data.map(item => ({
          timeStamp: item.timeEpochTimestamp * 1000,
          time: new Date(item.timeEpochTimestamp * 1000),
          open: item.openingPrice,
          high: item.highPrice,
          low: item.lowPrice,
          close: item.closingPrice
        }));

        let day = new Date();
        day.setDate(day.getDate() - 25);
        const xMin = day;
        let xMax = d3.max(data, d => new Date(Math.max(d.timeStamp)));
        xMax.setDate(xMax.getDate() + 1);
        x_scale.domain([xMin, xMax])
          .range([margin.left, width]);

        let visibleData = data.filter(item => (
          item.time >= x_scale.invert(margin.left)
          && item.time <= x_scale.invert(width)
        ));

        const yMin = d3.min(visibleData, d => Math.min(d.low));
        const yMax = d3.max(visibleData, d => Math.max(d.high));
        y_scale.domain([yMin, yMax])
          .range([height - margin.top, margin.bottom]);

        rectSelection = rectSelection.data(data).enter()
          .append("svg:rect")
          .attr("width", 10)
          .attr("x", d => x_scale(d.time) - 5)
          .attr("y", d => y_scale(Math.max(d.open, d.close)))
          .attr("height", d => (y_scale(Math.min(d.open, d.close)) - y_scale(Math.max(d.open, d.close))))
          .attr("fill", d => (d.open > d.close ? "red" : "green"))
          .attr("stroke", "black")
          .on("mouseover", function (d) {
            div.transition()
              .duration(200)
              .style("opacity", .9);
            div.html(timeFormat(d.time) + "<br/>" + d.close + "€")
              .style("left", (d3.event.pageX) + 28 + "px")
              .style("top", (d3.event.pageY - 28) + "px");
          })
          .on("mouseout", function (d) {
            div.transition()
              .duration(500)
              .style("opacity", 0);
          })
          .attr("clip-path", "url(#clip)");

        y_axis.call(yAxis);

        x_axis.call(xAxis);

        svg.call(zoom);

        function zoomed() {

          let new_x_scale = d3.event.transform.rescaleX(x_scale);
          xAxis = xAxis.scale(new_x_scale);
          x_axis.call(xAxis);

          let visibleData = data.filter(item => (
            item.time >= new_x_scale.invert(margin.left)
            && item.time <= new_x_scale.invert(width)
          ));

          const yMin = d3.min(visibleData, d => Math.min(d.low));
          const yMax = d3.max(visibleData, d => Math.max(d.high));
          y_scale.domain([yMin, yMax]);
          yAxis = yAxis.scale(y_scale);
          y_axis.call(yAxis);

          rectSelection
            .attr("x", d => new_x_scale(d.time) - 5)
            .attr("y", d => y_scale(Math.max(d.open, d.close)))
            .attr("height", d => (y_scale(Math.min(d.open, d.close)) - y_scale(Math.max(d.open, d.close))))

            ;
        }
      });


  </script>
</body>

</html>